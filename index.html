<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أرزاق للخردة - ERP System</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .bg-sudan-gradient { background: linear-gradient(180deg, #0056b3 0%, #f0c300 50%, #007b33 100%); }
        .text-sudan-blue { color: #0056b3; }
        .erp-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .erp-table th { background-color: #f8fafc; color: #64748b; font-weight: 700; text-align: right; padding: 16px; font-size: 0.85rem; border-bottom: 1px solid #e2e8f0; }
        .erp-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.95rem; }
        .erp-table tr:hover { background-color: #f8fafc; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer; }
        .checkbox-wrapper input { width: 18px; height: 18px; accent-color: #0056b3; }
        @media print {
            body * { visibility: hidden; }
            #document-paper, #document-paper * { visibility: visible; }
            #document-paper { position: absolute; left: 0; top: 0; width: 210mm !important; min-height: 297mm !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; background-color: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .fixed { display: none !important; }
            @page { size: A4; margin: 0mm; }
        }
    </style>
</head>
<body class="text-right overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                dashboard: <path d="M3 3h7v9H3zm11 0h7v5h-7zm0 9h7v9h-7zM3 16h7v5H3z" />,
                scale: <path d="M16 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM7 21h10M12 3v18M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" />,
                wallet: <><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4" /><path d="M4 6v12a2 2 0 0 0 2 2h14v-4" /><path d="M18 12a2 2 0 0 0 0 4h4v-4z" /></>,
                users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
                file: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></>,
                box: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></>,
                settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
                trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>,
                edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>,
                printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>,
                image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></>,
                pdf: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></>,
                close: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
                plus: <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
                phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />,
                chart: <><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></>,
                alert: <><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></>,
                lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const WinchLogo = ({ className = "w-12 h-12", colorClass = "text-blue-900" }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} ${colorClass}`}>
                <path d="M19 11v-2a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v2" />
                <path d="M12 9V2" />
                <path d="M8 2h8" />
                <path d="M12 11v6" />
                <path d="M12 17a3 3 0 0 1-3 3H8" />
                <path d="M12 17a3 3 0 0 0 3 3h1" />
                <circle cx="12" cy="11" r="2" />
            </svg>
        );

        const tafqeet = (amount) => amount ? `فقط ${amount.toLocaleString()} دينار ليبي لا غير` : "";
        const EXPENSE_ACCOUNTS = ['أتعاب قانونية', 'أتعاب محاسبية', 'أجهزة الكمبيوتر', 'أدوات مكتبية', 'إصلاح وصيانة', 'إيجار', 'التبرعات', 'الترفيه', 'دعايه وإعلان', 'رسوم مصرفية', 'كهرباء', 'مصاريف المركبات', 'هاتف'];

        const ALL_PERMISSIONS = [
            { id: 'dashboard', label: 'لوحة القيادة والتحليلات' },
            { id: 'accounting', label: 'المحاسبة والمركز المالي' },
            { id: 'weighbridge', label: 'نقطة الميزان (البيع والشراء)' },
            { id: 'financials', label: 'الخزينة والسندات المالية' },
            { id: 'inventory', label: 'المخزون' },
            { id: 'customers', label: 'إدارة العملاء' },
            { id: 'suppliers', label: 'إدارة الموردين' },
            { id: 'employees', label: 'إدارة الموظفين' },
            { id: 'reports', label: 'التقارير' },
            { id: 'settings', label: 'الإعدادات' },
            { id: 'users_manage', label: 'إدارة المستخدمين' },
            { id: 'delete_action', label: 'حذف المعاملات' },
            { id: 'edit_action', label: 'تعديل المعاملات' },
            { id: 'view_deleted', label: 'عرض سجل المحذوفات' }
        ];

        // --- Document Modal ---
        const DocumentModal = ({ data, onClose, settings }) => {
            const [isSaving, setIsSaving] = useState(false);
            const handlePrint = () => window.print();
            const captureAndSave = async (format) => {
                setIsSaving(true);
                const element = document.getElementById('document-paper');
                const clone = element.cloneNode(true);
                clone.style.width = '210mm'; clone.style.minHeight = '297mm'; clone.style.position = 'absolute'; clone.style.top = '-9999px'; clone.style.left = '0'; clone.style.boxShadow = 'none'; clone.style.margin = '0'; document.body.appendChild(clone);
                try {
                    await new Promise(r => setTimeout(r, 800));
                    const canvas = await window.html2canvas(clone, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    if (format === 'image') { const link = document.createElement('a'); link.download = `Doc-${data.id}.png`; link.href = imgData; link.click(); } 
                    else { const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4'); const w = pdf.internal.pageSize.getWidth(); const h = (canvas.height * w) / canvas.width; pdf.addImage(imgData, 'PNG', 0, 0, w, h); pdf.save(`Doc-${data.id}.pdf`); }
                    onClose();
                } catch(e) { console.error(e); alert('حدث خطأ'); } finally { document.body.removeChild(clone); setIsSaving(false); }
            };
            if (!data) return null;
            const isFinancial = data.category === 'financial';
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex flex-col font-sans">
                     <div className="bg-white p-4 shadow flex flex-wrap justify-between items-center z-50">
                        <h3 className="font-bold text-gray-700 text-lg">معاينة المستند</h3>
                        <div className="flex gap-2 mt-2 md:mt-0">
                            <button onClick={handlePrint} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded flex items-center gap-2"><Icon name="printer" size={16}/> طباعة</button>
                            <button onClick={() => captureAndSave('image')} disabled={isSaving} className="px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded flex items-center gap-2">{isSaving ? '...' : <><Icon name="image" size={16}/> صورة</>}</button>
                            <button onClick={() => captureAndSave('pdf')} disabled={isSaving} className="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded flex items-center gap-2">{isSaving ? '...' : <><Icon name="pdf" size={16}/> PDF</>}</button>
                            <button onClick={onClose} className="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300"><Icon name="close" size={20}/></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 flex justify-center bg-gray-200">
                        <div id="document-paper" className="bg-white shadow-2xl relative flex flex-col" style={{ width: '210mm', minHeight: '297mm', padding: '0', boxSizing: 'border-box' }}>
                            <div className="h-3 w-full bg-gray-800"></div>
                            <div className="p-12 flex flex-col h-full bg-white text-black">
                                <div className="flex justify-between items-start mb-12 border-b-2 border-gray-100 pb-8">
                                    <div className="w-1/2">
                                        <div className="flex items-center gap-3 mb-4"><WinchLogo className="w-14 h-14" colorClass="text-black" /><div><h1 className="text-3xl font-black text-black tracking-tight">{settings.companyName}</h1><p className="text-sm font-bold text-gray-500 uppercase">SCRAP MANAGEMENT</p></div></div>
                                        <div className="text-sm text-black font-medium leading-relaxed pr-1 space-y-1"><p className="font-bold text-lg">{settings.companyName}</p><p>{settings.address}</p><p className="mt-1 flex items-center gap-2 font-bold"><Icon name="phone" size={14}/> {settings.phone}</p></div>
                                    </div>
                                    <div className="text-left w-1/2">
                                        <h2 className="text-4xl font-light text-gray-300 uppercase mb-4 tracking-widest">{isFinancial ? (data.subType === 'receipt' ? 'سند قبض' : 'سند صرف') : 'فاتورة'}</h2>
                                        <table className="w-full text-left text-sm"><tbody><tr><td className="font-bold text-gray-500 py-1">الرقم:</td><td className="font-bold text-black py-1 text-right">#{data.id}</td></tr><tr><td className="font-bold text-gray-500 py-1">التاريخ:</td><td className="font-bold text-black py-1 text-right">{data.date}</td></tr>{data.time && <tr><td className="font-bold text-gray-500 py-1">الوقت:</td><td className="font-bold text-black py-1 text-right">{data.time}</td></tr>}</tbody></table>
                                    </div>
                                </div>
                                {!isFinancial ? (
                                    <>
                                        <div className="mb-10 flex justify-between bg-gray-50 p-5 rounded border border-gray-100">
                                            <div className="w-1/2 border-l border-gray-200 pl-4"><p className="text-xs font-bold text-gray-500 uppercase mb-2">العميل / المورد</p><h3 className="text-xl font-bold text-black mb-1">{data.client}</h3>{data.driverName && <p className="text-sm text-gray-600"><strong>السائق:</strong> {data.driverName}</p>}{data.vehicleNo && <p className="text-sm text-gray-600"><strong>السيارة:</strong> {data.vehicleNo}</p>}</div>
                                            <div className="text-left"><span className={`inline-block px-4 py-1.5 rounded-full text-sm font-bold border ${data.type === 'buy' ? 'bg-white border-green-600 text-green-700' : 'bg-white border-orange-600 text-orange-700'}`}>{data.type === 'buy' ? 'شراء (وارد)' : 'بيع (صادر)'}</span></div>
                                        </div>
                                        <div className="mb-8"><table className="w-full text-right border-collapse"><thead><tr className="bg-gray-800 text-white text-sm"><th className="py-3 px-4 font-bold">الصنف</th><th className="py-3 px-4 font-bold text-center">قائم</th><th className="py-3 px-4 font-bold text-center">فارغ</th><th className="py-3 px-4 font-bold text-center">خصم %</th><th className="py-3 px-4 font-bold text-center bg-gray-700">صافي</th><th className="py-3 px-4 font-bold text-left">سعر</th></tr></thead><tbody className="text-sm text-black"><tr className="border-b border-gray-200"><td className="py-4 px-4 font-bold">{data.ironType}</td><td className="py-4 px-4 text-center font-mono">{data.gross}</td><td className="py-4 px-4 text-center font-mono">{data.tare}</td><td className="py-4 px-4 text-center font-mono text-red-600">{data.deduction}%</td><td className="py-4 px-4 text-center font-mono font-bold bg-gray-100">{data.netWeight}</td><td className="py-4 px-4 text-left font-mono">{data.price}</td></tr></tbody></table></div>
                                        <div className="flex flex-col md:flex-row gap-10"><div className="flex-1"><div className="mb-4"><p className="text-xs font-bold text-gray-500 uppercase mb-1">المبلغ كتابة</p><p className="text-sm font-bold text-gray-800 italic bg-gray-50 p-2 rounded border border-gray-100">{tafqeet(data.total)}</p></div>{data.notes && <div><p className="text-xs font-bold text-gray-500 uppercase mb-1">ملاحظات</p><p className="text-sm text-black border-r-4 border-gray-300 pr-3">{data.notes}</p></div>}</div><div className="w-full md:w-5/12 bg-gray-50 p-6 rounded border border-gray-200"><div className="flex justify-between items-center py-1"><span className="font-bold text-black text-lg">الإجمالي</span><span className="font-black text-2xl text-black font-mono">{data.total.toLocaleString()} د.ل</span></div></div></div>
                                    </>
                                ) : (
                                    <div className="flex-1 flex flex-col justify-center"><div className="border-2 border-gray-900 p-8 mb-8 relative bg-gray-50"><div className="flex justify-between items-center mb-8 border-b border-gray-300 pb-4"><div><p className="text-gray-500 text-sm mb-1 font-bold">المبلغ</p><div className="text-4xl font-black font-mono bg-white px-6 py-2 border border-gray-400 text-black shadow-sm">{data.amount.toLocaleString()} د.ل</div></div><span className={`px-4 py-2 font-bold border-2 bg-white ${data.subType === 'receipt' ? 'border-green-600 text-green-800' : 'border-red-600 text-red-800'}`}>{data.subType === 'receipt' ? 'سند قبـض' : 'سند صـرف'}</span></div><div className="space-y-6 text-lg"><div className="flex gap-4"><span className="font-bold w-32">الاسم:</span><span className="font-bold flex-1 border-b border-dotted border-gray-400 pb-1">{data.employeeName || data.client || 'نقدية عامة'}</span></div><div className="flex gap-4"><span className="font-bold w-32">وذلك عن:</span><span className="font-bold flex-1 border-b border-dotted border-gray-400 pb-1">{data.description}</span></div><div className="flex gap-4"><span className="font-bold w-32">كتابة:</span><span className="font-bold italic flex-1 border-b border-dotted border-gray-400 pb-1">{tafqeet(data.amount)}</span></div></div></div></div>
                                )}
                                <div className="mt-auto pt-16 grid grid-cols-3 gap-8 text-center border-t-2 border-gray-800"><div><p className="text-sm font-bold mb-12">المستلم</p><div className="h-px bg-gray-400 w-3/4 mx-auto"></div></div><div><p className="text-sm font-bold mb-12">الختم</p><div className="h-24 w-24 border-2 border-double border-gray-300 rounded-full mx-auto flex items-center justify-center text-xs text-gray-400">ختم الشركة</div></div><div><p className="text-sm font-bold mb-12">المحاسب</p><div className="h-px bg-gray-400 w-3/4 mx-auto"></div></div></div>
                                <div className="text-center mt-8 text-xs text-gray-500 font-medium">تم إصدار المستند من نظام أرزاق</div>
                            </div>
                            <div className="h-4 w-full bg-gray-800"></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Screens & Components ---
        const AccountingScreen = ({ transactions }) => {
            const calculateBalance = () => {
                const financialTx = transactions.filter(t => t.category === 'financial');
                const sales = transactions.filter(t => t.category === 'weighbridge' && t.type === 'sell').reduce((a,b)=>a+b.total,0);
                const purchases = transactions.filter(t => t.category === 'weighbridge' && t.type === 'buy').reduce((a,b)=>a+b.total,0);
                const expensesMap = {};
                EXPENSE_ACCOUNTS.forEach(acc => { expensesMap[acc] = financialTx.filter(t => t.accountType === acc && t.subType === 'payment').reduce((a,b)=>a+b.amount,0); });
                const totalExpenses = Object.values(expensesMap).reduce((a,b)=>a+b,0);
                const netProfit = sales - purchases - totalExpenses;
                return { sales, purchases, expensesMap, totalExpenses, netProfit };
            };
            const data = calculateBalance();
            return (
                <div className="space-y-6 animate-fadeInUp">
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div className="bg-gray-50 p-4 border-b border-gray-200"><h2 className="font-bold text-gray-800 flex items-center gap-2"><Icon name="chart"/> قائمة الدخل (Income Statement)</h2></div>
                        <div className="p-4">
                            <div className="bg-green-50 text-green-800 font-bold p-2">الدخل (Revenue)</div>
                            <div className="flex justify-between py-2 px-4 border-b"><span>المبيعات</span><span className="font-mono font-bold">{data.sales.toLocaleString()}</span></div>
                            <div className="bg-red-50 text-red-800 font-bold p-2 mt-4">المصروفات (Expenses)</div>
                            <div className="flex justify-between py-2 px-4 border-b"><span>تكلفة البضاعة (المشتريات)</span><span className="font-mono font-bold">{data.purchases.toLocaleString()}</span></div>
                            {EXPENSE_ACCOUNTS.map(acc => data.expensesMap[acc] > 0 && (<div key={acc} className="flex justify-between py-2 px-8 border-b border-gray-100"><span className="text-gray-600">{acc}</span><span className="font-mono">{data.expensesMap[acc].toLocaleString()}</span></div>))}
                            <div className="flex justify-between items-center p-4 bg-gray-800 text-white font-bold mt-4"><span>صافي الربح (الخسارة)</span><span className={`font-mono text-xl ${data.netProfit >= 0 ? 'text-green-400' : 'text-red-400'}`}>{data.netProfit.toLocaleString()} د.ل</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        const DeletedTransactions = ({ transactions }) => {
            const deleted = transactions.filter(t => t.isDeleted);
            return (
                <div className="bg-white rounded-lg shadow p-6 animate-fadeInUp">
                    <h2 className="text-2xl font-bold text-red-600 mb-6 flex items-center gap-2"><Icon name="trash"/> سجل المحذوفات (Audit Log)</h2>
                    <table className="erp-table">
                        <thead><tr><th>التاريخ</th><th>النوع</th><th>الوصف</th><th>المبلغ</th><th>حُذف بواسطة</th><th>وقت الحذف</th></tr></thead>
                        <tbody>
                            {deleted.map(tx => (
                                <tr key={tx.id} className="bg-red-50">
                                    <td>{tx.date}</td>
                                    <td>{tx.category === 'weighbridge' ? 'ميزان' : 'مالية'}</td>
                                    <td>{tx.category === 'weighbridge' ? `${tx.type === 'buy' ? 'شراء' : 'بيع'} - ${tx.client}` : tx.description}</td>
                                    <td className="font-bold">{tx.total || tx.amount}</td>
                                    <td>{tx.deletedBy}</td>
                                    <td>{new Date(tx.deletedAt).toLocaleString('ar-LY')}</td>
                                </tr>
                            ))}
                            {deleted.length === 0 && <tr><td colSpan="6" className="text-center py-8 text-gray-400">لا توجد سجلات محذوفة</td></tr>}
                        </tbody>
                    </table>
                </div>
            );
        };

        const UsersManagementScreen = ({ users, onAddUser, onDeleteUser }) => {
            const [newUser, setNewUser] = useState({ name: '', username: '', password: '', role: 'user', permissions: [] });
            
            const handlePermissionChange = (permId) => {
                if (newUser.permissions.includes(permId)) {
                    setNewUser({...newUser, permissions: newUser.permissions.filter(p => p !== permId)});
                } else {
                    setNewUser({...newUser, permissions: [...newUser.permissions, permId]});
                }
            };

            const saveUser = () => {
                if(!newUser.name || !newUser.username || !newUser.password) return alert('البيانات ناقصة');
                onAddUser({...newUser, id: Date.now()});
                setNewUser({ name: '', username: '', password: '', role: 'user', permissions: [] });
            };

            return (
                <div className="bg-white rounded-lg shadow p-6 animate-fadeInUp">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Icon name="users"/> إدارة المستخدمين والصلاحيات</h2>
                    
                    <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                        <h3 className="font-bold mb-4 text-blue-800">إضافة مستخدم جديد</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label className="block text-xs font-bold mb-1">الاسم الكامل</label><input className="w-full p-2 border rounded" value={newUser.name} onChange={e=>setNewUser({...newUser, name: e.target.value})}/></div>
                            <div><label className="block text-xs font-bold mb-1">اسم المستخدم (للدخول)</label><input className="w-full p-2 border rounded" dir="ltr" value={newUser.username} onChange={e=>setNewUser({...newUser, username: e.target.value})}/></div>
                            <div><label className="block text-xs font-bold mb-1">كلمة المرور</label><input className="w-full p-2 border rounded" dir="ltr" value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})}/></div>
                        </div>
                        <div className="mb-4">
                            <label className="block text-xs font-bold mb-2">نوع الحساب</label>
                            <div className="flex gap-4">
                                <label className="flex items-center gap-2"><input type="radio" name="role" checked={newUser.role==='admin'} onChange={()=>setNewUser({...newUser, role:'admin'})}/> مسؤول (كامل الصلاحيات)</label>
                                <label className="flex items-center gap-2"><input type="radio" name="role" checked={newUser.role==='user'} onChange={()=>setNewUser({...newUser, role:'user'})}/> مستخدم عادي (صلاحيات محددة)</label>
                            </div>
                        </div>
                        
                        {newUser.role === 'user' && (
                            <div className="mb-6 bg-white p-4 rounded border border-gray-200">
                                <p className="text-xs font-bold mb-3 text-gray-500">تحديد الصلاحيات:</p>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {ALL_PERMISSIONS.map(p => (
                                        <label key={p.id} className="checkbox-wrapper text-sm">
                                            <input type="checkbox" checked={newUser.permissions.includes(p.id)} onChange={() => handlePermissionChange(p.id)} />
                                            {p.label}
                                        </label>
                                    ))}
                                </div>
                            </div>
                        )}
                        <button onClick={saveUser} className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">حفظ المستخدم</button>
                    </div>

                    <table className="erp-table">
                        <thead><tr><th>الاسم</th><th>اسم المستخدم</th><th>كلمة المرور</th><th>النوع</th><th>الصلاحيات</th><th>حذف</th></tr></thead>
                        <tbody>
                            {users.map(u => (
                                <tr key={u.id}>
                                    <td className="font-bold">{u.name}</td>
                                    <td className="font-mono">{u.username}</td>
                                    <td className="font-mono text-gray-400">******</td>
                                    <td><span className={`px-2 py-1 rounded text-xs font-bold ${u.role==='admin'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700'}`}>{u.role==='admin'?'مسؤول':'مستخدم'}</span></td>
                                    <td className="text-xs text-gray-500 max-w-xs truncate">{u.role === 'admin' ? 'الكل' : u.permissions.length + ' صلاحيات'}</td>
                                    <td>{u.role !== 'admin' && <button onClick={() => onDeleteUser(u.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash" size={16}/></button>}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const TransactionList = ({ type, data, onView, onDelete, onEdit, canModify }) => (
            <div className="bg-white rounded-lg shadow p-6 animate-fadeInUp">
                <h2 className="text-2xl font-bold text-gray-800 mb-6">{type === 'all' ? 'أرشيف العمليات' : type}</h2>
                <table className="erp-table">
                    <thead><tr><th>رقم</th><th>التاريخ</th><th>الوصف</th><th>الوزن/البيان</th><th>الإجمالي</th><th>إجراءات</th></tr></thead>
                    <tbody>
                        {data.filter(t => !t.isDeleted).map(tx => (
                            <tr key={tx.id}>
                                <td className="font-mono">#{tx.id}</td>
                                <td>{tx.date}</td>
                                <td className="font-bold">{tx.category === 'weighbridge' ? tx.client : tx.description}</td>
                                <td>{tx.category === 'weighbridge' ? `${tx.netWeight} كجم` : tx.accountType}</td>
                                <td className="font-bold text-blue-700">{(tx.total || tx.amount).toLocaleString()}</td>
                                <td className="flex gap-2">
                                    <button onClick={() => onView(tx)} className="btn-action text-gray-600 hover:bg-gray-100" title="معاينة"><Icon name="file" size={16}/></button>
                                    {canModify && <button onClick={() => onEdit(tx)} className="btn-action btn-edit" title="تعديل"><Icon name="edit" size={16}/></button>}
                                    {canModify && <button onClick={() => onDelete(tx.id)} className="btn-action btn-delete" title="حذف"><Icon name="trash" size={16}/></button>}
                                </td>
                            </tr>
                        ))}
                         {data.filter(t => !t.isDeleted).length === 0 && <tr><td colSpan="6" className="text-center py-8 text-gray-400">السجل فارغ</td></tr>}
                    </tbody>
                </table>
            </div>
        );

        const ContactList = ({ title, data, onAdd, onDelete }) => {
            const [newName, setNewName] = useState(''); const [newPhone, setNewPhone] = useState('');
            return (<div className="bg-white rounded-lg shadow p-6 animate-fadeInUp"><h2 className="text-2xl font-bold text-gray-800 mb-6">{title}</h2><div className="flex gap-4 mb-6 bg-gray-50 p-4 rounded-lg items-end"><div className="flex-1"><label className="block text-sm font-bold text-gray-600 mb-1">الاسم</label><input className="w-full p-2 border rounded" value={newName} onChange={e=>setNewName(e.target.value)} placeholder="اسم جديد..."/></div><div className="flex-1"><label className="block text-sm font-bold text-gray-600 mb-1">رقم الهاتف</label><input className="w-full p-2 border rounded" value={newPhone} onChange={e=>setNewPhone(e.target.value)} placeholder="09..."/></div><button onClick={() => { if(newName){ onAdd({id: Date.now(), name: newName, phone: newPhone, balance: 0}); setNewName(''); setNewPhone(''); }}} className="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">إضافة</button></div><table className="erp-table"><thead><tr><th>الاسم</th><th>الهاتف</th><th>الرصيد</th><th>إجراءات</th></tr></thead><tbody>{data.map(c => (<tr key={c.id}><td className="font-bold">{c.name}</td><td>{c.phone}</td><td className={`font-mono font-bold ${c.balance < 0 ? 'text-red-600' : 'text-green-600'}`}>{c.balance.toLocaleString()}</td><td><button onClick={() => onDelete(c.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash" size={16}/></button></td></tr>))}{data.length === 0 && <tr><td colSpan="4" className="text-center py-8 text-gray-400">لا توجد بيانات</td></tr>}</tbody></table></div>);
        };
        
        const SettingsScreen = ({ settings, onSave }) => {
            const [local, setLocal] = useState(settings);
            return (
                <div className="bg-white rounded-lg shadow p-6 animate-fadeInUp max-w-2xl mx-auto">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Icon name="settings"/> إعدادات النظام</h2>
                    <div className="space-y-4">
                        <div><label className="block font-bold mb-1">اسم الشركة</label><input className="w-full p-2 border rounded" value={local.companyName} onChange={e=>setLocal({...local, companyName: e.target.value})}/></div>
                        <div><label className="block font-bold mb-1">العنوان</label><input className="w-full p-2 border rounded" value={local.address} onChange={e=>setLocal({...local, address: e.target.value})}/></div>
                        <div><label className="block font-bold mb-1">رقم الهاتف</label><input className="w-full p-2 border rounded" value={local.phone} onChange={e=>setLocal({...local, phone: e.target.value})}/></div>
                        <button onClick={() => onSave(local)} className="w-full py-3 bg-green-600 text-white font-bold rounded hover:bg-green-700 mt-4">حفظ التغييرات</button>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                const valid = onLogin(username, password);
                if (!valid) setError('بيانات الدخول غير صحيحة'); 
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-sudan-gradient p-4"><div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden"><div className="bg-blue-600 p-8 text-center text-white bg-opacity-90"><div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"><WinchLogo className="w-12 h-12" colorClass="text-white" /></div><h2 className="text-3xl font-black mb-1">أرزاق للخردة</h2><p className="text-blue-100 text-sm">نظام الإدارة المتكامل</p></div><div className="p-8"><form onSubmit={handleSubmit} className="space-y-6"><div><label className="block text-sm font-bold text-gray-700 mb-2">اسم المستخدم</label><input type="text" className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all text-left" dir="ltr" placeholder="Username" value={username} onChange={(e) => setUsername(e.target.value)} /></div><div><label className="block text-sm font-bold text-gray-700 mb-2">كلمة المرور</label><input type="password" className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all text-left" dir="ltr" placeholder="•••••••" value={password} onChange={(e) => setPassword(e.target.value)} /></div>{error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm font-bold flex items-center gap-2"><Icon name="close" size={16} /> {error}</div>}<button type="submit" className="w-full py-3.5 bg-blue-900 text-white rounded-xl font-bold hover:bg-black transition-all shadow-lg flex items-center justify-center gap-2"><Icon name="users" size={20} /> تسجيل الدخول</button></form></div><div className="bg-gray-50 p-4 text-center text-xs text-gray-400 border-t">&copy; {new Date().getFullYear()} Arzaq Scrap System</div></div></div>
            );
        };

        const ArzaqApp = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('weighbridge');
            const [currentDocument, setCurrentDocument] = useState(null);
            
            // Storage
            const useSticky = (key, init) => {
                const [val, setVal] = useState(() => JSON.parse(localStorage.getItem(key)) || init);
                useEffect(() => localStorage.setItem(key, JSON.stringify(val)), [key, val]);
                return [val, setVal];
            };

            const [inventory, setInventory] = useSticky('inv', [{ id: 1, name: 'حديد ثقيل', stock: 0 }, { id: 2, name: 'حديد خفيف', stock: 0 }, { id: 3, name: 'نحاس', stock: 0 }]);
            const [transactions, setTransactions] = useSticky('txs', []);
            const [customers, setCustomers] = useSticky('cust', []);
            const [suppliers, setSuppliers] = useSticky('supp', []);
            const [employees, setEmployees] = useSticky('employees', []);
            const [settings, setSettings] = useSticky('conf', { companyName: 'أرزاق للخردة', address: 'زليتن القاعة', phone: '0911234567' });
            const [appUsers, setAppUsers] = useSticky('app_users', [
                { id: 1, name: 'المسؤول', username: '605002026', password: '2026112233', role: 'admin', permissions: [] },
                { id: 2, name: 'مستخدم عادي', username: '6002025', password: '1122331', role: 'user', permissions: ['weighbridge', 'financials', 'sales', 'purchases'] }
            ]);

            const [weighData, setWeighData] = useState({ type: 'buy', client: '', driverName: '', vehicleNo: '', ironId: '1', gross: '', tare: '', deduction: 0, price: '', notes: '', date: new Date().toISOString().split('T')[0], id: Date.now().toString().slice(-6) });
            const [financialEntry, setFinancialEntry] = useState({ type: 'receipt', amount: '', description: '', employeeId: '', accountType: '', date: new Date().toISOString().split('T')[0] });

            const hasPermission = (pid) => user?.role === 'admin' || user?.permissions?.includes(pid);

            const treasury = useMemo(() => {
                let bal = 0;
                transactions.filter(t => !t.isDeleted).forEach(t => {
                    const amt = t.total || t.amount;
                    if (t.category === 'weighbridge') { if (t.type === 'buy') bal -= amt; else bal += amt; }
                    else { if (t.subType === 'receipt') bal += amt; else bal -= amt; }
                });
                return bal;
            }, [transactions]);

            const calcNet = () => {
                const g = Number(weighData.gross)||0; const t = Number(weighData.tare)||0; const d = Number(weighData.deduction)||0;
                return Math.round((g - t) * (1 - d/100));
            };

            const handleLogin = (u, p) => {
                const found = appUsers.find(usr => usr.username === u && usr.password === p);
                if (found) { setUser(found); return true; }
                return false;
            };

            const saveWeigh = () => {
                if(!weighData.client || !weighData.price) return alert('بيانات ناقصة');
                const net = calcNet();
                if(net <= 0) return alert('خطأ في الوزن');
                const iron = inventory.find(i => i.id == weighData.ironId);
                const total = net * Number(weighData.price);
                const newTx = { ...weighData, id: weighData.id, ironType: iron.name, netWeight: net, total, category: 'weighbridge', time: new Date().toLocaleTimeString('ar-LY', {hour:'2-digit', minute:'2-digit'}), isDeleted: false };
                setTransactions([newTx, ...transactions]);
                setInventory(inventory.map(i => i.id == iron.id ? {...i, stock: weighData.type === 'buy' ? i.stock + net : i.stock - net} : i));
                setCurrentDocument(newTx);
                setWeighData({...weighData, gross: '', tare: '', deduction: 0, client: '', driverName: '', vehicleNo: '', price: '', notes: '', id: Date.now().toString().slice(-6)});
            };

            const saveFinancial = () => {
                if(!financialEntry.amount) return alert("أدخل المبلغ");
                const newTx = { id: Math.floor(Math.random()*1000000), category: 'financial', ...financialEntry, amount: Number(financialEntry.amount), isDeleted: false };
                setTransactions([newTx, ...transactions]);
                setFinancialEntry({ type: 'receipt', amount: '', description: '', employeeId: '', accountType: '', date: new Date().toISOString().split('T')[0] });
                setCurrentDocument(newTx);
            };

            const deleteTx = (id) => {
                if(!confirm('هل أنت متأكد؟')) return;
                const tx = transactions.find(t => t.id === id);
                if(tx.category === 'weighbridge') {
                    const iron = inventory.find(i => i.name === tx.ironType);
                    if(iron) {
                        const revStock = tx.type === 'buy' ? -tx.netWeight : tx.netWeight;
                        setInventory(inventory.map(i => i.id === iron.id ? {...i, stock: i.stock + revStock} : i));
                    }
                }
                setTransactions(transactions.map(t => t.id === id ? { ...t, isDeleted: true, deletedBy: user.name, deletedAt: new Date().toISOString() } : t));
            };

            const handleEditTransaction = (tx) => {
                if(!confirm('سيتم حذف المعاملة الحالية للتعديل. متابعة؟')) return;
                deleteTx(tx.id); 
                if (tx.category === 'weighbridge') {
                    const iron = inventory.find(i => i.name === tx.ironType);
                    setWeighData({ ...tx, ironId: iron ? iron.id : '1', date: new Date(tx.date).toISOString().split('T')[0] });
                    setActiveTab('weighbridge');
                } else {
                    setFinancialEntry({ ...tx, date: new Date(tx.date).toISOString().split('T')[0] });
                    setActiveTab('financials');
                }
            };

            const handleAddEmployee = (emp) => { setEmployees([...employees, emp]); alert("تم"); };
            const handleDeleteEmployee = (id) => { setEmployees(employees.filter(e => e.id !== id)); };

            if (!user) return <LoginScreen onLogin={handleLogin} />;
            const isAdmin = user.role === 'admin';

            return (
                <div className="min-h-screen flex bg-gray-100">
                    {currentDocument && <DocumentModal data={currentDocument} onClose={() => setCurrentDocument(null)} managementNumbers={[settings.phone]} settings={settings} />}
                    <aside className="w-64 bg-sudan-gradient text-white fixed h-full z-10 shadow-xl flex flex-col">
                        <div className="h-20 flex items-center justify-center border-b border-white/20 bg-black/10"><h2 className="font-black text-xl tracking-wider">أرزاق ERP</h2></div>
                        <nav className="flex-1 overflow-y-auto py-4 space-y-1">
                            {hasPermission('weighbridge') && <button onClick={()=>setActiveTab('weighbridge')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='weighbridge'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="scale"/> الميزان</button>}
                            {hasPermission('dashboard') && <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='dashboard'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="dashboard"/> لوحة القيادة</button>}
                            {hasPermission('accounting') && <button onClick={()=>setActiveTab('accounting')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='accounting'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="chart"/> المحاسبة</button>}
                            {hasPermission('financials') && <button onClick={()=>setActiveTab('financials')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='financials'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="wallet"/> الخزينة</button>}
                            {hasPermission('sales') && <button onClick={()=>setActiveTab('sales')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='sales'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="file"/> المبيعات</button>}
                            {hasPermission('purchases') && <button onClick={()=>setActiveTab('purchases')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='purchases'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="file"/> المشتريات</button>}
                            {hasPermission('customers') && <button onClick={()=>setActiveTab('customers')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='customers'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="users"/> العملاء</button>}
                            {hasPermission('suppliers') && <button onClick={()=>setActiveTab('suppliers')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='suppliers'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="users"/> الموردين</button>}
                            {hasPermission('inventory') && <button onClick={()=>setActiveTab('inventory')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='inventory'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="box"/> المخزون</button>}
                            {hasPermission('employees') && <button onClick={()=>setActiveTab('employees')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='employees'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="users"/> الموظفين</button>}
                            {hasPermission('reports') && <button onClick={()=>setActiveTab('reports')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='reports'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="file"/> التقارير</button>}
                            {hasPermission('users_manage') && <button onClick={()=>setActiveTab('users')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='users'?'bg-white text-sudan-blue border-r-4 border-yellow-400':'hover:bg-white/10'}`}><Icon name="users"/> المستخدمين</button>}
                            {hasPermission('view_deleted') && <button onClick={()=>setActiveTab('deleted')} className={`w-full flex items-center gap-3 px-6 py-3 text-sm font-bold transition-all ${activeTab==='deleted'?'bg-red-800 text-white':'hover:bg-red-900 text-red-200'}`}><Icon name="trash"/> المحذوفات</button>}
                            <button onClick={()=>setUser(null)} className="w-full flex items-center gap-3 px-6 py-3 text-sm font-bold text-red-300 hover:bg-red-900/50 mt-auto"><Icon name="close"/> خروج</button>
                        </nav>
                    </aside>
                    <main className="flex-1 mr-64 p-8 overflow-y-auto h-screen">
                        <div className="flex justify-between items-center mb-8"><h1 className="text-2xl font-black text-gray-800 border-r-4 border-sudan-blue pr-3">نظام الإدارة</h1><div className="text-sm font-bold text-gray-500"><span className="ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded">{user.name}</span> الخزينة: <span className={treasury>=0?"text-green-600":"text-red-600"}>{treasury.toLocaleString()} د.ل</span></div></div>
                        
                        {activeTab === 'weighbridge' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fadeInUp">
                                <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-800 text-white p-4 flex justify-between items-center"><h3 className="font-bold flex items-center gap-2"><Icon name="scale"/> عملية جديدة</h3><div className="flex bg-gray-700 rounded p-1"><button onClick={() => setWeighData({...weighData, type: 'buy'})} className={`px-4 py-1 rounded text-sm font-bold ${weighData.type === 'buy' ? 'bg-green-500 text-white' : 'text-gray-300'}`}>شراء</button><button onClick={() => setWeighData({...weighData, type: 'sell'})} className={`px-4 py-1 rounded text-sm font-bold ${weighData.type === 'sell' ? 'bg-orange-500 text-white' : 'text-gray-300'}`}>بيع</button></div></div>
                                    <div className="p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold text-gray-600 mb-1">رقم الفاتورة</label><input type="number" className="w-full p-2 border rounded" value={weighData.id} onChange={e => setWeighData({...weighData, id: e.target.value})}/></div><div><label className="block text-sm font-bold text-gray-600 mb-1">التاريخ</label><input type="date" className="w-full p-2 border rounded" value={weighData.date} onChange={e => setWeighData({...weighData, date: e.target.value})}/></div></div>
                                        <div className="grid grid-cols-3 gap-4"><div className="col-span-1"><label className="block text-sm font-bold text-gray-600 mb-1">العميل</label><input type="text" list="cust-list" className="w-full p-2 border rounded" value={weighData.client} onChange={e => setWeighData({...weighData, client: e.target.value})}/><datalist id="cust-list">{customers.map(c => <option key={c.id} value={c.name}/>)}</datalist></div><div><label className="block text-sm font-bold text-gray-600 mb-1">السائق</label><input type="text" className="w-full p-2 border rounded" value={weighData.driverName} onChange={e => setWeighData({...weighData, driverName: e.target.value})}/></div><div><label className="block text-sm font-bold text-gray-600 mb-1">رقم السيارة</label><input type="text" className="w-full p-2 border rounded" value={weighData.vehicleNo} onChange={e => setWeighData({...weighData, vehicleNo: e.target.value})}/></div></div>
                                        <div className="bg-blue-50 p-4 rounded border border-blue-100 grid grid-cols-4 gap-4 text-center"><div><label className="block text-xs font-bold text-gray-500">الصنف</label><select className="w-full p-1 border rounded" value={weighData.ironId} onChange={e=>setWeighData({...weighData, ironId: e.target.value})}>{inventory.map(i=><option key={i.id} value={i.id}>{i.name}</option>)}</select></div><div><label className="block text-xs font-bold text-gray-500">القائم</label><input type="number" className="w-full p-1 border rounded text-center" value={weighData.gross} onChange={e=>setWeighData({...weighData, gross: e.target.value})}/></div><div><label className="block text-xs font-bold text-gray-500">الفارغ</label><input type="number" className="w-full p-1 border rounded text-center" value={weighData.tare} onChange={e=>setWeighData({...weighData, tare: e.target.value})}/></div><div><label className="block text-xs font-bold text-red-500">خصم %</label><input type="number" className="w-full p-1 border rounded text-center border-red-200" value={weighData.deduction} onChange={e=>setWeighData({...weighData, deduction: e.target.value})}/></div></div>
                                        <div className="flex gap-4 items-end"><div className="w-1/3"><label className="block text-sm font-bold text-gray-600 mb-1">سعر الكيلو</label><input type="number" className="w-full p-2 border-2 border-yellow-400 rounded font-bold text-center" value={weighData.price} onChange={e=>setWeighData({...weighData, price: e.target.value})}/></div><button onClick={saveWeigh} className="flex-1 py-2 bg-gradient-to-r from-blue-700 to-blue-900 text-white font-bold rounded shadow hover:opacity-90">حفظ وطباعة</button></div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-center items-center text-center"><p className="text-gray-500 font-bold mb-2">الصافي الحالي</p><h2 className="text-6xl font-black text-gray-800 font-mono tracking-tighter mb-4">{calcNet()}</h2><div className="w-full border-t pt-4 flex justify-between"><span className="text-gray-500 font-bold">الإجمالي</span><span className="text-2xl font-black text-green-600">{(calcNet() * (Number(weighData.price)||0)).toLocaleString()}</span></div></div>
                            </div>
                        )}
                        {activeTab === 'financials' && (
                            <div className="animate-fadeInUp grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white rounded-xl shadow border border-gray-200 p-6">
                                    <h3 className="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2"><Icon name="plus"/> تسجيل عملية مالية</h3>
                                    <div className="flex gap-2 mb-4 bg-gray-50 p-1 rounded-lg">{['receipt', 'payment', 'advance'].map(t => (<button key={t} onClick={() => setFinancialEntry({...financialEntry, type: t})} className={`flex-1 py-2 rounded-md text-sm font-bold ${financialEntry.type === t ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>{t === 'receipt' ? 'قبض' : t === 'payment' ? 'صرف' : 'سلفة'}</button>))}</div>
                                    <div className="space-y-4">
                                        {financialEntry.type === 'payment' && (<div><label className="block text-sm font-bold text-gray-600 mb-1">نوع المصروف</label><select className="w-full p-2 border rounded" value={financialEntry.accountType} onChange={e=>setFinancialEntry({...financialEntry, accountType: e.target.value})}><option value="">-- اختر --</option>{EXPENSE_ACCOUNTS.map(acc => <option key={acc} value={acc}>{acc}</option>)}</select></div>)}
                                        {financialEntry.type === 'receipt' && (<div><label className="block text-sm font-bold text-gray-600 mb-1">نوع الإيراد</label><select className="w-full p-2 border rounded" value={financialEntry.accountType} onChange={e=>setFinancialEntry({...financialEntry, accountType: e.target.value})}><option value="">-- اختر --</option><option value="الفوائد المستلمة">الفوائد المستلمة</option><option value="ايرادات اخرى">إيرادات أخرى</option></select></div>)}
                                        <div><label className="block text-sm font-bold text-gray-600 mb-1">المبلغ</label><input type="number" className="w-full p-2 border rounded" value={financialEntry.amount} onChange={e=>setFinancialEntry({...financialEntry, amount: e.target.value})}/></div>
                                        <div><label className="block text-sm font-bold text-gray-600 mb-1">البيان</label><input className="w-full p-2 border rounded" value={financialEntry.description} onChange={e=>setFinancialEntry({...financialEntry, description: e.target.value})}/></div>
                                        <button onClick={saveFinancial} className="w-full py-3 bg-gray-800 text-white rounded font-bold hover:bg-black">حفظ وطباعة السند</button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow border border-gray-200 p-6 overflow-hidden flex flex-col"><h3 className="font-bold text-gray-800 mb-4">آخر الحركات</h3><div className="flex-1 overflow-y-auto">{transactions.filter(t => t.category === 'financial' && !t.isDeleted).map(t => (<div key={t.id} className="flex justify-between items-center p-3 border-b hover:bg-gray-50 cursor-pointer" onClick={() => setCurrentDocument(t)}><div><p className={`font-bold text-sm ${t.subType==='receipt'?'text-green-600':'text-red-600'}`}>{t.subType==='receipt'?'قبض':'صرف'}: {t.description}</p><p className="text-xs text-gray-400">{t.date}</p></div><span className="font-mono font-bold">{t.amount.toLocaleString()}</span></div>))}</div></div>
                            </div>
                        )}
                        {activeTab === 'accounting' && <AccountingScreen transactions={transactions.filter(t => !t.isDeleted)} />}
                        {activeTab === 'dashboard' && (
                             <div className="bg-white p-6 rounded shadow animate-fadeInUp">
                                 <h2 className="font-bold text-xl mb-4">لوحة القيادة</h2>
                                 <div className="grid grid-cols-4 gap-4 text-center">
                                     <div className="bg-blue-50 p-4 rounded"><p className="text-sm text-gray-500">المبيعات</p><p className="font-bold text-xl">{transactions.filter(t => t.type === 'sell' && !t.isDeleted).reduce((a,b)=>a+b.total,0).toLocaleString()}</p></div>
                                     <div className="bg-orange-50 p-4 rounded"><p className="text-sm text-gray-500">المشتريات</p><p className="font-bold text-xl">{transactions.filter(t => t.type === 'buy' && !t.isDeleted).reduce((a,b)=>a+b.total,0).toLocaleString()}</p></div>
                                     <div className="bg-red-50 p-4 rounded"><p className="text-sm text-gray-500">المصروفات</p><p className="font-bold text-xl">{transactions.filter(t => t.subType === 'payment' && !t.isDeleted).reduce((a,b)=>a+b.amount,0).toLocaleString()}</p></div>
                                     <div className="bg-green-50 p-4 rounded"><p className="text-sm text-gray-500">الخزينة</p><p className="font-bold text-xl">{treasury.toLocaleString()}</p></div>
                                 </div>
                             </div>
                        )}
                        {activeTab === 'users' && isAdmin && <UsersManagementScreen users={appUsers} onAddUser={u => setAppUsers([...appUsers, u])} onDeleteUser={id => setAppUsers(appUsers.filter(u => u.id !== id))} />}
                        {activeTab === 'customers' && <ContactList title="العملاء (Customers)" data={customers} onAdd={c => setCustomers([...customers, c])} onDelete={id => isAdmin ? setCustomers(customers.filter(c => c.id !== id)) : alert('ليس لديك صلاحية')} />}
                        {activeTab === 'suppliers' && <ContactList title="الموردين (Suppliers)" data={suppliers} onAdd={s => setSuppliers([...suppliers, s])} onDelete={id => isAdmin ? setSuppliers(suppliers.filter(s => s.id !== id)) : alert('ليس لديك صلاحية')} />}
                        {activeTab === 'sales' && <TransactionList type="sales" data={transactions.filter(t => t.type === 'sell')} onView={setCurrentDocument} onDelete={deleteTx} canModify={hasPermission('delete_action')} />}
                        {activeTab === 'purchases' && <TransactionList type="purchases" data={transactions.filter(t => t.type === 'buy')} onView={setCurrentDocument} onDelete={deleteTx} canModify={hasPermission('delete_action')} />}
                        {activeTab === 'inventory' && (
                            <div className="bg-white rounded-lg shadow p-6 animate-fadeInUp">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">المخزون</h2>
                                <table className="erp-table">
                                    <thead><tr><th>الاسم</th><th>الكمية (كجم)</th></tr></thead>
                                    <tbody>{inventory.map(i => <tr key={i.id}><td className="font-bold">{i.name}</td><td>{i.stock.toLocaleString()}</td></tr>)}</tbody>
                                </table>
                            </div>
                        )}
                        {activeTab === 'reports' && <TransactionList type="all" data={transactions} onView={setCurrentDocument} onDelete={deleteTx} canModify={hasPermission('delete_action')} />}
                        {activeTab === 'settings' && <SettingsScreen settings={settings} onSave={setSettings} />}
                        {activeTab === 'deleted' && <DeletedTransactions transactions={transactions} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ArzaqApp />);
    </script>
</body>
</html>
